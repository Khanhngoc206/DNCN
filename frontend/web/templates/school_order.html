{% extends "base.html" %}
{% block content %}

<h1 class="text-center mt-4">ƒê·∫∑t ƒë·ªìng ph·ª•c s·ªë l∆∞·ª£ng l·ªõn</h1>

<div class="container mt-4">

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>Size</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Gi√°</th>
        </tr>
    </thead>

    <tbody id="order-rows">
        {% for sp in products %}
        <tr data-product-id="{{ sp.masanpham }}">
            <td><strong>{{ sp.tensanpham }}</strong></td>

            <td>
                <select class="form-select size-select">
                    <option value="">-- Ch·ªçn size --</option>
                </select>
            </td>

            <td>
                <input type="number"
                       class="form-control qty-input"
                       value="0"
                       min="0">
            </td>

            <td class="price-box">0 ƒë</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h4 class="text-end mt-3">
    T·ªïng ti·ªÅn:
    <span id="total-price" class="text-danger fw-bold">0 ƒë</span>
</h4>

<div class="text-end">
    <button id="submit-btn" class="btn btn-primary btn-lg mt-3">
        G·ª≠i ƒë∆°n
    </button>
</div>

</div>

<script>
const API_BASE = "http://127.0.0.1:8000";

/* =====================================
   1. LOAD SIZE + ƒê∆†N GI√Å
===================================== */
async function loadSizes() {
    for (let row of document.querySelectorAll("#order-rows tr")) {
        const masanpham = row.dataset.productId;
        const select = row.querySelector(".size-select");

        try {
            const res = await fetch(`${API_BASE}/sanpham/phienban/${masanpham}`);
            const data = await res.json();

            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.masize;
                opt.textContent = `Size ${item.size}`;
                opt.dataset.price = item.dongia;              // ‚úÖ QUAN TR·ªåNG
                opt.dataset.maphienban = item.maphienban;    // ‚úÖ QUAN TR·ªåNG
                select.appendChild(opt);
            });

        } catch (err) {
            console.error("L·ªói load size:", err);
        }
    }
}

/* =====================================
   2. T√çNH GI√Å T·ª™ dongia
===================================== */
function updateRow(row) {
    const qty = Number(row.querySelector(".qty-input").value || 0);
    const opt = row.querySelector(".size-select").selectedOptions[0];

    const dongia = Number(opt?.dataset.price || 0);
    const thanhtien = dongia * qty;

    row.querySelector(".price-box").textContent =
        thanhtien.toLocaleString("vi-VN") + " ƒë";

    updateTotal();
}

function updateTotal() {
    let sum = 0;
    document.querySelectorAll(".price-box").forEach(box => {
        sum += Number(box.textContent.replace(/\D/g, "") || 0);
    });

    document.getElementById("total-price").textContent =
        sum.toLocaleString("vi-VN") + " ƒë";
}

/* =====================================
   3. G·∫ÆN EVENT
===================================== */
function bindEvents() {
    document.querySelectorAll("#order-rows tr").forEach(row => {
        row.querySelector(".size-select")
            .addEventListener("change", () => updateRow(row));

        row.querySelector(".qty-input")
            .addEventListener("input", () => updateRow(row));
    });
}

/* =====================================
   4. SUBMIT ‚Üí G·ª¨I dongia
===================================== */
document.getElementById("submit-btn").addEventListener("click", async () => {
    const cart = {};

    document.querySelectorAll("#order-rows tr").forEach(row => {
        const masanpham = row.dataset.productId;
        const qty = Number(row.querySelector(".qty-input").value || 0);
        const opt = row.querySelector(".size-select").selectedOptions[0];

        if (qty > 0 && opt) {
            cart[masanpham] = {
                maphienban: Number(opt.dataset.maphienban),
                tensize: opt.textContent.replace("Size ", ""),
                soluong: qty,
                dongia: Number(opt.dataset.price)   // ‚úÖ ƒê√öNG T√äN
            };
        }
    });

    if (Object.keys(cart).length === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m");
        return;
    }

    const res = await fetch("/school/order/submit/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ cart })
    });

    if (res.ok) {
        alert("üéâ G·ª≠i ƒë∆°n th√†nh c√¥ng!");
        location.reload();
    } else {
        alert("‚ùå G·ª≠i ƒë∆°n th·∫•t b·∫°i");
    }
});

/* =====================================
   INIT
===================================== */
document.addEventListener("DOMContentLoaded", async () => {
    await loadSizes();
    bindEvents();
});
</script>

{% endblock %}
