{% extends "admin/admin_base.html" %}
{% block title %}ƒê∆°n h√†ng{% endblock %}

{% block content %}
<h3 class="mb-3">üßæ Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>

<table class="table table-striped table-bordered shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>M√£ ƒêH</th>
            <th>Kh√°ch h√†ng / Tr∆∞·ªùng</th>
            <th>Ng√†y</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th width="180">H√†nh ƒë·ªông</th>
        </tr>
    </thead>

    <tbody>
    {% for dh in ds_donhang %}
    <tr>
        <td>{{ dh.madon }}</td>

        <!-- üî• V√¨ h·ªá th·ªëng c·ªßa b·∫°n d√πng matruong (kh√¥ng d√πng makh) -->
        <td>
            {% if dh.matruong %}
                Tr∆∞·ªùng #{{ dh.matruong }}
            {% else %}
                Kh√°ch l·∫ª
            {% endif %}
        </td>

        <td>{{ dh.ngay }}</td>

        <td>{{ dh.tongtien|floatformat:"0" }}‚Ç´</td>

        <td>
            <span class="badge bg-info">{{ dh.trangthai }}</span>
        </td>

        <td>
            <!-- N√∫t xem chi ti·∫øt -->
            <button onclick="openDetail({{ dh.madon }})" 
                    class="btn btn-primary btn-sm">
                Xem
            </button>

            <!-- N√∫t tr·∫°ng th√°i -->
            <form action="/admin/donhang/status/" method="POST" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="id" value="{{ dh.madon }}">
                <button class="btn btn-warning btn-sm">Tr·∫°ng th√°i</button>
            </form>

            <!-- N√∫t x√≥a -->
            <form action="/admin/donhang/delete/" method="POST" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="id" value="{{ dh.madon }}">
                <button class="btn btn-danger btn-sm">X√≥a</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>


<!-- üåü MODAL CHI TI·∫æT -->
<div class="modal fade" id="modalDetail" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="detailContent">
        ƒêang t·∫£i...
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function openDetail(id) {
    let modal = new bootstrap.Modal(document.getElementById("modalDetail"));
    document.getElementById("detailContent").innerHTML = "ƒêang t·∫£i...";

    fetch(`/admin/donhang/${id}/chitiet/`)
        .then(res => res.text())
        .then(html => {
            document.getElementById("detailContent").innerHTML = html;
            modal.show();
        })
        .catch(err => {
            document.getElementById("detailContent").innerHTML =
                "<p class='text-danger'>L·ªói t·∫£i d·ªØ li·ªáu!</p>";
        });
}
</script>
{% endblock %}
